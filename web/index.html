<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>User Story Map</title>
    <script type="text/javascript" src="lib/d3/d3.v5.min.js"></script>
    <script type="text/javascript" src="lib/d3/d3-selection-multi.v1.min.js"></script>
    <script type="text/javascript" src="lib/d3/d3-polygon.v1.min.js"></script>
    <style type="text/css">
        html,
        body {
            margin: 0;
            padding: 0;
        }

        #usm {
            position: absolute;
            background: lightgrey;
            width: 100%;
            height: 100%;
            overflow: hidden;
            /*  "overflow: hidden" is a fix for the little gap
                at the bottom, that appears in combination with
                "height: 100%" on the svg element.
            */
        }

        #usm svg {
            width: 100%;
            height: 100%;
            background: lightblue
        }
    </style>

    <script type="text/javascript">
        var USM = function (jsonUSM) {

            this.jsonData = jsonUSM

            this.timeline = new Timeline()
            this.roadmap = new Roadmap(this.jsonData.usm.roadmap)
            this.backbone = new Backbone(this.jsonData.usm.backbone)


            // console.log("USM::jsonData", this.jsonData) // DEBUG

            // prepare roadmap to add max number of cards in each release:
            Object.keys(this.jsonData.usm.roadmap.release).forEach(function (releaseKey, index) {
                this.jsonData.usm.roadmap.release[releaseKey].maxCards = 0
            }, this)

            // optimize data:
            Object.keys(this.jsonData.usm.backbone.step).forEach(function (stepKey, index) {

                // console.log("step", this.jsonData.usm.backbone.step[stepKey].title._text) // DEBUG

                // put single cards inside a step.body.card into an array
                // as multiple cards already are. This makes further processing cleaner:
                if (!Array.isArray(this.jsonData.usm.backbone.step[stepKey].body.card)) {
                    var tempCard = this.jsonData.usm.backbone.step[stepKey].body.card
                    this.jsonData.usm.backbone.step[stepKey].body.card = []
                    this.jsonData.usm.backbone.step[stepKey].body.card[0] = tempCard
                }

                // add max number of related cards to each release:

                // count occurences in step:
                var occurences = {}
                Object.keys(this.jsonData.usm.backbone.step[stepKey].body.card).forEach(function (
                    cardKey,
                    index) {

                    if ("_attributes" in this.jsonData.usm.backbone.step[stepKey].body.card[cardKey]) {

                        var release = this.jsonData.usm.backbone.step[stepKey].body.card[cardKey]._attributes
                            .release

                        if (release in occurences) {
                            occurences[release] += 1
                        } else {
                            occurences[release] = 1
                        }

                    }

                }, this)

                // update maxCards in each release with collected number of occurences in this step:
                Object.keys(this.jsonData.usm.roadmap.release).forEach(function (releaseKey, index) {
                    var releaseId = this.jsonData.usm.roadmap.release[releaseKey].id._text
                    if (occurences[releaseId] > this.jsonData.usm.roadmap.release[releaseKey].maxCards) {
                        this.jsonData.usm.roadmap.release[releaseKey].maxCards = occurences[
                            releaseId]
                    }
                }, this)

            }, this)

            console.log("USM::jsonData", this.jsonData) // DEBUG


        }
        USM.prototype.render = function (domElement, margins, debug = false) {

            // create canvas as base element for all children to append their elements to:

            var svgUSM = domElement
                .append("svg")
                .attrs({
                    class: "usm",
                    x: 0,
                    y: 0
                })

            var canvas = svgUSM
                .append("g")
                .attrs({
                    transform: "translate(" + margins.left + "," + margins.top + ")"
                })


            // calculate dimensions to pass to child objects:

            svgWidth = parseInt(svgUSM.style("width"))
            svgHeight = parseInt(svgUSM.style("height"))

            canvasWidth = svgWidth - margins.left - margins.right
            canvasHeight = svgHeight - margins.top - margins.bottom

            console.log("svgWidth svgHeight:", svgWidth, svgHeight) // DEBUG
            console.log("canvasWidth canvasHeight:", canvasWidth, canvasHeight) // DEBUG


            // render children:

            this.timeline.render(canvas, canvasWidth, 70)
            this.backbone.render(canvas)
            this.roadmap.render(canvas, canvasWidth)


            // render debug information:

            var renderBoundingBox = function (domElement, margins, svgWidth, svgHeight) {

                var svgBoundingBox = domElement
                    .append("rect")
                    .attrs({
                        x: 0,
                        y: 0,
                        width: svgWidth - margins.left - margins.right,
                        height: svgHeight - margins.top - margins.bottom,
                    })
                    .styles({
                        "stroke": "#f00",
                        "stroke-width": 1,
                        "stroke-dasharray": "10,10",
                        "fill": "none"
                    })
            }

            if (debug) {
                var svgDebugElements = canvas
                    .append("g")
                    .attrs({
                        class: "debug"
                    })

                renderBoundingBox(svgDebugElements, margins, svgWidth, svgHeight)
            }

        }

        var Roadmap = function (jsonRoadmap) {
            this.jsonRoadmap = jsonRoadmap
        }
        Roadmap.prototype.render = function (domElement, width) {
            console.log("Roadmap::render() -> this.jsonRoadmap", this.jsonRoadmap) // DEBUG

            var svgRoadmap = domElement
                .append("g")
                .attrs({
                    class: "roadmap",
                    transform: "translate(0,80)"
                })

            Object.keys(this.jsonRoadmap.release).forEach(function (releaseKey, index) {

                // calculate y-offset for this release:
                var offsetY = 0
                for (var i = 0; i <= releaseKey; i++) {
                    if (this.jsonRoadmap.release[i].maxCards === 0) {
                        offsetY += 24
                    } else {
                        offsetY += this.jsonRoadmap.release[i].maxCards * 70 + 4
                    }
                }

                var svgRelease = svgRoadmap
                    .append("g")
                    .attrs({
                        class: "release",
                        transform: "translate(0," + offsetY + ")"
                    })

                svgRelease
                    .append("rect")
                    .attrs({
                        x: 0,
                        y: 0,
                        width: width,
                        height: 1
                    })

                svgRelease
                    .append("text")
                    .text(this.jsonRoadmap.release[releaseKey].name._text + " (" + this.jsonRoadmap.release[releaseKey].maxCards + ")")
                    .attrs({
                        x: 0,
                        y: -5,
                        width: width,
                        height: 1
                    })
            }, this)
        }

        var Card = function (jsonCard) {
            this.jsonCard = jsonCard
        }
        Card.prototype.render = function (domElement, offsetX = 0, offsetY = 0) {

            var width = 100
            var height = 60

            var svgCard = domElement
                .append("g")
                .attrs({
                    class: "card",
                    transform: "translate(" + offsetX + ", " + offsetY + ")"
                })

            svgCard
                .append("rect")
                .attrs({
                    width: width,
                    height: height
                })
                .styles({
                    stroke: "#000",
                    strokeWidth: 1,
                    fill: "#fff"
                })

            // render title of card:
            svgCard
                .append("text")
                .text(this.jsonCard.title._text)
                .attrs({
                    x: width / 2,
                    y: height / 2
                })
                .styles({
                    "alignment-baseline": "middle",
                    "text-anchor": "middle",
                })

            // render id of release this card belongs to:
            if ("_attributes" in this.jsonCard && "release" in this.jsonCard._attributes) {
                svgCard
                    .append("text")
                    .text("[" + this.jsonCard._attributes.release + "]")
                    .attrs({
                        x: width / 2,
                        y: height / 2 + 16
                    })
                    .styles({
                        "alignment-baseline": "middle",
                        "text-anchor": "middle",
                    })
            }

            return svgCard
        }

        var Step = function (jsonStep) {
            this.jsonStep = jsonStep
        }
        Step.prototype.render = function (domElement, offsetX = 0) {

            var svgStep = domElement
                .append("g")
                .attrs({
                    class: "step"
                })

            // render step card:
            var card = new Card(this.jsonStep)
            card.render(svgStep, offsetX)

            var svgCards = svgStep
                .append("g")
                .attrs({
                    class: "cards",
                    transform: "translate(" + offsetX + "," + 84 + ")"
                })

            this.renderCards(svgCards, this.jsonStep.body.card)
        }
        Step.prototype.renderCards = function (domElement, jsonCards, offsetY = 0) {

            Object.keys(jsonCards).forEach(function (key, index) {
                var card = new Card(jsonCards[key])
                card.render(domElement, 0, index * 70)
            })

        }
        var Backbone = function (jsonBackbone) {
            this.jsonBackbone = jsonBackbone

        }
        Backbone.prototype.render = function (domElement) {

            var svgBackbone = domElement
                .append("g")
                .attrs({
                    class: "backbone"
                })

            this.jsonBackbone.step.forEach(function (jsonStep, index) {
                var step = new Step(jsonStep)
                step.render(svgBackbone, index * 110)
            }, this)

            return svgBackbone
        }

        var Timeline = function () {}
        Timeline.prototype.render = function (domElement, width, offsetY = 0) {

            var svgTimeline = domElement
                .append("polygon")
                .attrs({
                    points: [
                        [0, 0],
                        [width - 20, 0],
                        [width - 20, -4],
                        [width, 2],
                        [width - 20, 8],
                        [width - 20, 4],
                        [0, 4]
                    ],
                    transform: "translate(0, " + offsetY + ")",
                    class: "timeline"
                })
                .styles({
                    "fill": "#000"
                })

            return svgTimeline

        }
    </script>

    <script type="text/javascript">
        const apiEndpoint = "http://localhost:8080"
        const margins = {
            top: 40,
            right: 20,
            bottom: 40,
            left: 20
        }

        document.addEventListener("DOMContentLoaded", function (event) {

            var url = apiEndpoint + "/data"

            d3.json(url)
                .then((result) => {

                    var usm = new USM(result.data)
                    usm.render(d3.select("#usm"), margins, true)

                })
                .catch((error) => {
                    console.error("Error:", error)
                })

        })
    </script>

</head>

<body>
    <div id="usm"></div>
</body>

</html>