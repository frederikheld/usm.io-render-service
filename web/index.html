<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>User Story Map</title>
    <script type="text/javascript" src="lib/jquery/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="lib/d3/d3.v5.min.js"></script>
    <script type="text/javascript" src="lib/d3/d3-selection-multi.v1.min.js"></script>
    <script type="text/javascript" src="lib/d3/d3-polygon.v1.min.js"></script>
    <style type="text/css">
        html,
        body {
            margin: 0;
            padding: 0;
        }

        #usm {
            position: absolute;
            background: lightgrey;
            width: 100%;
            height: 100%;
            overflow: hidden;
            /*  "overflow: hidden" is a fix for the little gap
                at the bottom, that appears in combination with
                "height: 100%" on the svg element.
            */
        }

        #usm svg {
            width: 100%;
            height: 100%;
            background: lightblue
        }
    </style>

    <script type="text/javascript">
        var USM = function (jsonUSM) {

            this.jsonData = jsonUSM

            this.timeline = new Timeline()
            this.backbone = new Backbone(this.jsonData.usm.backbone)

        }
        USM.prototype.render = function (domElement, margins, debug = false) {

            // create canvas as base element for all children to append their elements to:

            var svgUSM = domElement
                .append("svg")
                .attrs({
                    class: "usm",
                    x: 0,
                    y: 0
                })

            var canvas = svgUSM
                .append("g")
                .attrs({
                    transform: "translate(" + margins.left + "," + margins.top + ")"
                })


            // calculate dimensions to pass to child objects:

            svgWidth = parseInt(svgUSM.style("width"))
            svgHeight = parseInt(svgUSM.style("height"))

            canvasWidth = svgWidth - margins.left - margins.right
            canvasHeight = svgHeight - margins.top - margins.bottom

            console.log("svgWidth svgHeight:", svgWidth, svgHeight) // DEBUG
            console.log("canvasWidth canvasHeight:", canvasWidth, canvasHeight) // DEBUG


            // render children:

            this.timeline.render(canvas, canvasWidth, 70)
            this.backbone.render(canvas)


            // render debug information:

            var renderBoundingBox = function (domElement, margins, svgWidth, svgHeight) {

                var svgBoundingBox = domElement
                    .append("rect")
                    .attrs({
                        x: 0,
                        y: 0,
                        width: svgWidth - margins.left - margins.right,
                        height: svgHeight - margins.top - margins.bottom,
                    })
                    .styles({
                        "stroke": "#f00",
                        "stroke-width": 1,
                        "stroke-dasharray": "10,10",
                        "fill": "none"
                    })
            }

            if (debug) {
                var svgDebugElements = canvas
                    .append("g")
                    .attrs({
                        class: "debug"
                    })

                renderBoundingBox(svgDebugElements, margins, svgWidth, svgHeight)
            }

        }

        var Card = function (jsonCard) {
            this.jsonCard = jsonCard
        }
        Card.prototype.render = function (domElement, offsetX = 0, offsetY = 0) {

            var width = 100
            var height = 60

            var svgCard = domElement
                .append("g")
                .attrs({
                    class: "card",
                    transform: "translate(" + offsetX + ", " + offsetY + ")"
                })

            svgCard
                .append("rect")
                .attrs({
                    width: width,
                    height: height
                })
                .styles({
                    stroke: "#000",
                    strokeWidth: 1,
                    fill: "#fff"
                })

            svgCard
                .append("text")
                .text(this.jsonCard.title._text)
                .attrs({
                    x: width / 2,
                    y: height / 2
                })
                .styles({
                    "alignment-baseline": "middle",
                    "text-anchor": "middle",
                })

            return svgCard
        }

        var Backbone = function (jsonBackbone) {
            this.jsonBackbone = jsonBackbone
        }
        Backbone.prototype.render = function (domElement) {

            var svgBackbone = domElement
                .append("g")
                .attrs({
                    class: "backbone"
                })

            this.jsonBackbone.step.forEach(function (jsonStep, index) {
                var step = new Card(jsonStep)
                step.render(svgBackbone, index * 110)
            }, this)

            return svgBackbone
        }

        var Timeline = function () {}
        Timeline.prototype.render = function (domElement, width, offsetY = 0) {

            var svgTimeline = domElement
                .append("polygon")
                .attrs({
                    points: [
                        [0, 0],
                        [width - 20, 0],
                        [width - 20, -4],
                        [width, 2],
                        [width - 20, 8],
                        [width - 20, 4],
                        [0, 4]
                    ],
                    transform: "translate(0, " + offsetY + ")",
                    class: "timeline"
                })
                .styles({
                    "fill": "#000"
                })

            return svgTimeline

        }
    </script>

    <script type="text/javascript">
        const apiEndpoint = "http://localhost:8080"
        const margins = {
            top: 40,
            right: 20,
            bottom: 40,
            left: 20
        }

        $(document).ready(function () {
            $.ajax({
                url: apiEndpoint + "/data"
            }).then(function (data) {

                console.log("data.data", data.data)

                var usm = new USM(data.data)
                usm.render(d3.select("#usm"), margins, true)

            })
        })
    </script>

</head>

<body>
    <div id="usm"></div>
</body>

</html>