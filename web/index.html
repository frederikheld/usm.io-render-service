<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>User Story Map</title>
    <script type="text/javascript" src="lib/jquery/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="lib/d3/d3.v5.min.js"></script>
    <script type="text/javascript" src="lib/d3/d3-selection-multi.v1.min.js"></script>
    <script type="text/javascript" src="lib/d3/d3-polygon.v1.min.js"></script>
    <style type="text/css">
        html,
        body {
            margin: 0;
            padding: 0;
        }

        #usm {
            position: absolute;
            background: lightgrey;
            width: 100%;
            height: 100%;
            overflow: hidden;
            /*  "overflow: hidden" is a fix for the little gap
                at the bottom, that appears in combination with
                "height: 100%" on the svg element.
            */
        }

        #usm svg {
            width: 100%;
            height: 100%;
            background: lightblue
        }
    </style>

    <script type="text/javascript">
        var USM = function (domSelector, jsonData, margins) {

            // store params:

            this.domSelector = domSelector
            this.jsonData = jsonData
            this.margins = margins


            // create svg element as canvas:

            this.canvas = d3.select(this.domSelector)
                .append("svg")
                .attrs({
                    xmlns: "http://www.w3.org/2000/svg",
                })


            // store canvas dimensions:

            this.canvasWidth = parseInt(this.canvas.style("width"))
            this.canvasHeight = parseInt(this.canvas.style("height"))


            // render the whole thing:

            this.render(true)
        }

        USM.prototype.render = function (debug = false) {

            this.renderTimeline()
            this.renderBackbone()

            if (debug) {
                this.renderBoundingBox()
            }
        }

        /**
         * Renders the given jsonItem into a story card and
         * attaches it to the given snapObject.
         */
        USM.prototype.renderCard = function (jsonCard, offsetX = 0, offsetY = 0) {

            var width = 100
            var height = 60

            var svgCard = this.canvas
                .append("g")
                .attrs({
                    class: "card",
                    transform: "translate(" + offsetX + ", " + offsetY + ")"
                })

            svgCard
                .append("rect")
                .attrs({
                    width: width,
                    height: height
                })
                .styles({
                    stroke: "#000",
                    strokeWidth: 1,
                    fill: "#fff"
                })

            svgCard
                .append("text")
                .text(jsonCard.title._text)
                .attrs({
                    x: width / 2,
                    y: height / 2
                })
                .styles({
                    "alignment-baseline": "middle",
                    "text-anchor": "middle",
                })

            return svgCard

        }

        USM.prototype.renderStep = function (jsonStep, offsetX = 0, offsetY = 0) {

            var svgStep = this.canvas
                .append("g")
                .attrs({
                    class: "step"
                })

            var svgCard = svgStep
                .append(function () {
                    return d3.select("#svg").append("g").attr("class", "debug")
                }, this)

            // svgCard
            //     .append("rect")
            //     .attrs({
            //         x: offsetX,
            //         y: offsetY,
            //         width: 40,
            //         height: 20
            //     })

            // svgCard
            //     .append("text")
            //     .text("Hello World!")


            // render backbone card above timeline:

            // svgStep
            // .append(function () {
            // return function () {
            //     return this.renderCard(jsonStep, offsetX, offsetY)
            // }
            // })


            // render all body cards on a horizontal axis below timeline:

            return svgStep

        }

        /**
         * Renders the given jsonBackbone above the timeline
         * of the given snapObject
         */
        USM.prototype.renderBackbone = function () {

            this.jsonData.usm.backbone.step.forEach(function (jsonStep, index) {

                this.renderStep(jsonStep, index * 110)

            }, this)


        }

        USM.prototype.renderTimeline = function () {

            var offsetX = this.margins.left
            var offsetY = 100

            var svgTimeline = this.canvas
                .append("polygon")
                .attrs({
                    points: [
                        [0, 0],
                        [this.canvasWidth - this.margins.left - this.margins.right - 20, 0],
                        [this.canvasWidth - this.margins.left - this.margins.right - 20, -4],
                        [this.canvasWidth - this.margins.left - this.margins.right, 2],
                        [this.canvasWidth - this.margins.left - this.margins.right - 20, 8],
                        [this.canvasWidth - this.margins.left - this.margins.right - 20, 4],
                        [0, 4]
                    ],
                    transform: "translate(" + offsetX + ", " + offsetY + ")",
                    class: "timeline"
                })
                .styles({
                    "fill": "#666"
                })

        }

        USM.prototype.renderBoundingBox = function () {

            var svgBoundingBox = this.canvas
                .append("rect")
                .attrs({
                    x: this.margins.left,
                    y: this.margins.top,
                    width: this.canvasWidth - this.margins.left - this.margins.right,
                    height: this.canvasHeight - this.margins.top - this.margins.bottom,
                })
                .styles({
                    "stroke": "#f00",
                    "stroke-width": 1,
                    "stroke-dasharray": "10,10",
                    "fill": "none"
                })

        }
    </script>

    <script type="text/javascript">
        const apiEndpoint = "http://localhost:8080"
        const margins = {
            top: 40,
            right: 20,
            bottom: 40,
            left: 20
        }

        $(document).ready(function () {
            $.ajax({
                url: apiEndpoint + "/data"
            }).then(function (data) {

                console.log("data:", data)

                var usm = new USM("#usm", data.data, margins)

            })
        })
    </script>

</head>

<body>
    <div id="usm"></div>
</body>

</html>